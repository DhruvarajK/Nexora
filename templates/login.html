<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nex - Login / Register</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link as="style" href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700;900&family=Space+Grotesk:wght@400;500;700&display=swap" onload="this.rel='stylesheet'" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <script src="static/tailwind.js"></script>

  <!-- Tailwind-style utilities (kept as you had them) -->
  <style type="text/tailwindcss">
    body {
      font-family: "Space Grotesk", "Noto Sans", sans-serif;
    }
    .form-input {
      @apply w-full pl-10 rounded-md border border-gray-700 bg-black px-4 py-3 text-white placeholder-gray-500 focus:border-white focus:ring-white;
    }
    .form-label {
      @apply mb-2 text-sm font-medium text-gray-400 ml-4;
    }
  </style>

  <!-- Responsive background + layout tweaks -->
  <style>
    .bg-hero {
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      min-height: 100vh;
    }
    .bg-hero {
      background-image: url("/static/cat-nex-ds.jpg");
    }
    @media (min-width: 768px) {
      .bg-hero {
        background-image: url("/static/cat-nex-mb.jpg");
      }
    }
    .overlay {
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }
    .login-card { transition: transform 220ms cubic-bezier(.2,.8,.2,1), opacity 220ms; }
    /* view switch animation helpers */
    .view-enter { transform: translateY(6px); opacity: 0; }
    .view-enter-active { transform: translateY(0); opacity: 1; transition: transform 220ms ease, opacity 220ms ease; }
    .view-exit { transform: translateY(0); opacity: 1; }
    .view-exit-active { transform: translateY(-6px); opacity: 0; transition: transform 180ms ease, opacity 180ms ease; }

    /* Small helper if tailwind 'hidden' isn't present in runtime build */
    .hidden { display: none !important; }

    /* Spinner styles (self-contained, doesn't rely on Tailwind utilities) */
    .btn-spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      vertical-align: middle;
      margin-right: .625rem; /* 10px */
    }
    .spin {
      animation: spin 1s linear infinite;
      transform-origin: 50% 50%;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Optional visual when disabled */
    .btn-disabled {
      opacity: 0.85;
      cursor: default;
      pointer-events: none;
    }
  </style>
</head>

<body class="bg-black text-white">
  <div class="relative flex min-h-screen w-full flex-col md:p-4 bg-hero justify-center" id="page-root">
    <div class="absolute inset-0 bg-black/70 overlay"></div>

    <!-- Card container -->
    <div id="auth-card" class="relative z-10 w-full max-w-md rounded-2xl bg-zinc-900/30 p-8 shadow-2xl login-card
                mx-auto h-[auto] md:h-[100vh] md:mx-0 md:ml-0 md:mr-auto">

      <!-- Logo + header area -->
      <div id="header" class="text-center md:text-left">
        <svg class="ml-[44%] md:ml-0" width="35" height="35" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 7L10 0H8L2 7V9H7L6 16H8L14 9L14 7H9Z" fill="currentColor"/></svg>
      </div>

      <!-- Container for both views -->
      <div class="mt-6 space-y-2">
        <!-- Login View -->
        <section id="login-view" class="space-y-6" aria-hidden="false">
          <div>
            <h2 class="text-3xl font-bold tracking-tight">Log in to Nex</h2>
            <p class="mt-2 text-sm text-gray-400">Welcome back! Please enter your details.</p>
          </div>

          <!-- Login form -->
          <form id="login-form" class="space-y-6" method="post" action="/login">

            <div>
              <label for="email" class="form-label">Username or Email</label>
              <div class="relative">
                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">person</span>
                <input id="email" name="email" type="email" autocomplete="email" required class="form-input pl-10" placeholder="you@example.com"/>
              </div>
            </div>

            <div>
              <label for="password" class="form-label">Password</label>
              <div class="relative">
                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">lock</span>
                <input id="password" name="password" type="password" autocomplete="current-password" required class="form-input pl-10" placeholder="••••••••"/>
              </div>
            </div>

            <div class="flex items-center justify-between text-sm">
              <a href="#" class="font-medium text-gray-300 hover:text-white transition">Forgot password?</a>
            </div>

            <div>
              <!-- Login button with embedded spinner and text spans -->
              <button
                id="login-button"
                type="submit"
                class="flex w-full items-center justify-center rounded-3xl bg-white py-3 px-4 text-sm font-semibold text-black shadow-sm transition-transform duration-200 ease-in-out hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-white active:scale-95"
                aria-live="polite"
              >
                <!-- spinner SVG is hidden by default -->
                <svg class="btn-spinner spin hidden" viewBox="0 0 50 50" aria-hidden="true" focusable="false">
                  <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-dasharray="31.4 31.4" />
                </svg>
                <span id="login-btn-text">Log In</span>
              </button>
            </div>
          </form>

          <p class="mt-6 text-center md:text-left text-sm text-gray-400">
            Don't have an account?
            <a href="#" id="show-register" class="font-medium text-white hover:underline">Sign up</a>
          </p>
        </section>

        <!-- Register View (hidden initially) -->
        <section id="register-view" class="space-y-6 hidden" aria-hidden="true">
          <div>
            <h2 class="text-3xl font-bold tracking-tight">Create account</h2>
            <p class="mt-2 text-sm text-gray-400">Create a new account to get started.</p>
          </div>

          <!-- Register form -->
          <form id="register-form" class="space-y-6" method="post" action="/register">
            <div>
              <label for="reg-username" class="form-label">Username</label>
              <div class="relative">
                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">badge</span>
                <input id="reg-username" name="username" type="text" class="form-input pl-10" placeholder="your handle"/>
              </div>
            </div>

            <div>
              <label for="reg-email" class="form-label">Email</label>
              <div class="relative">
                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">email</span>
                <input id="reg-email" name="email" type="email" autocomplete="email" required class="form-input pl-10" placeholder="you@example.com"/>
              </div>
            </div>

            <div>
              <label for="reg-password" class="form-label">Password</label>
              <div class="relative">
                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">lock</span>
                <input id="reg-password" name="password" type="password" autocomplete="new-password" required class="form-input pl-10" placeholder="Create a password"/>
              </div>
            </div>

            <div>
              <label for="reg-dob" class="form-label">Date of birth (YYYY-MM-DD)</label>
              <input id="reg-dob" name="date_of_birth" type="date" class="form-input" />
            </div>

            <div>
              <button type="submit" class="flex w-full justify-center rounded-3xl bg-white py-3 px-4 text-sm font-semibold text-black shadow-sm transition-transform duration-200 ease-in-out hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-white active:scale-95">
                Register
              </button>
            </div>
          </form>

          <p class="mt-6 text-center md:text-left text-sm text-gray-400">
            Already have an account?
            <a href="#" id="show-login" class="font-medium text-white hover:underline">Log in</a>
          </p>
        </section>
      </div>
    </div>
  </div>

  <!-- Small script to toggle views in-place + spinner handling -->
  <script>
    (function () {
      const root = document.querySelector('.bg-hero') || document.getElementById('page-root');
      function applyAlignment() {
        if (!root) return;
        if (window.innerWidth >= 768) {
          root.classList.add('items-start', 'pl-12','md:h-[100vh]');
          root.classList.remove('items-center', 'px-4');
          if (window.innerWidth >= 1024) {
            root.classList.add('md:h-[100vh]');
          } else {
            root.classList.remove('md:h-[100vh]');
          }
        } else {
          root.classList.remove('items-start', 'pl-12', 'lg:pl-24','md:h-[100vh]');
          root.classList.add('items-center', 'px-4');
        }
      }
      applyAlignment();
      window.addEventListener('resize', applyAlignment);

      // Views
      const loginView = document.getElementById('login-view');
      const registerView = document.getElementById('register-view');
      const showRegister = document.getElementById('show-register');
      const showLogin = document.getElementById('show-login');

      function show(view) {
        if (view === 'register') {
          // animate out login
          loginView.classList.add('view-exit-active');
          loginView.setAttribute('aria-hidden', 'true');
          setTimeout(()=> {
            loginView.classList.add('hidden');
            loginView.classList.remove('view-exit-active');
            // show register
            registerView.classList.remove('hidden');
            registerView.classList.add('view-enter-active');
            registerView.setAttribute('aria-hidden', 'false');
            setTimeout(()=> registerView.classList.remove('view-enter-active'), 300);
          }, 160);
        } else {
          registerView.classList.add('view-exit-active');
          registerView.setAttribute('aria-hidden', 'true');
          setTimeout(()=> {
            registerView.classList.add('hidden');
            registerView.classList.remove('view-exit-active');
            loginView.classList.remove('hidden');
            loginView.classList.add('view-enter-active');
            loginView.setAttribute('aria-hidden', 'false');
            setTimeout(()=> loginView.classList.remove('view-enter-active'), 300);
          }, 160);
        }
      }

      showRegister.addEventListener('click', function (e) {
        e.preventDefault();
        show('register');
        // optional: update url hash without refreshing
        history.replaceState(null, '', '#register');
      });

      showLogin.addEventListener('click', function (e) {
        e.preventDefault();
        show('login');
        history.replaceState(null, '', '#login');
      });

      // Respect direct links: if URL has #register show register on load
      if (location.hash === '#register') show('register');
      if (location.hash === '#login') show('login');

      /* ---------- Spinner and disable-on-submit logic for login button ---------- */
      /* ---------- Spinner and disable-on-submit logic for login button (REPLACE THIS BLOCK) ---------- */
const loginForm = document.getElementById('login-form');
const loginButton = document.getElementById('login-button');
const spinner = loginButton.querySelector('.btn-spinner');
const btnText = document.getElementById('login-btn-text');

function showSpinner(text = 'Logging in...') {
  spinner.classList.remove('hidden');
  btnText.textContent = text;
  loginButton.classList.add('btn-disabled');
  loginButton.disabled = true;                     // disable now (after we intercepted submit)
  loginButton.setAttribute('aria-disabled', 'true');
  loginButton.setAttribute('aria-busy', 'true');
}

function hideSpinner() {
  spinner.classList.add('hidden');
  btnText.textContent = 'Log In';
  loginButton.classList.remove('btn-disabled');
  loginButton.disabled = false;
  loginButton.removeAttribute('aria-disabled');
  loginButton.removeAttribute('aria-busy');
}

/* Submit handler: validate, show spinner, send via fetch, handle success/failure */
loginForm.addEventListener('submit', function (ev) {
  ev.preventDefault();

  // If browser validation fails, show validation UI and don't proceed.
  if (!loginForm.checkValidity()) {
    // reportValidity shows native UI messages
    loginForm.reportValidity();
    return;
  }

  // Show spinner + disable button (we do this AFTER validation so we don't interfere with native UI)
  showSpinner();

  // Prepare form data to send (progressive enhancement)
  const action = loginForm.getAttribute('action') || window.location.href;
  const method = (loginForm.getAttribute('method') || 'POST').toUpperCase();
  const formData = new FormData(loginForm);

  // Send as same-origin fetch; server should accept standard form posts.
  fetch(action, {
    method,
    body: formData,
    credentials: 'same-origin',
    headers: { 'X-Requested-With': 'XMLHttpRequest' } // helpful for server-side detection
  })
    .then(async (res) => {
      // If the server redirected, follow it
      if (res.redirected) {
        window.location.href = res.url;
        return;
      }

      if (res.ok) {
        // Try parse JSON redirect (optional)
        try {
          const data = await res.json().catch(() => null);
          if (data && data.redirect) {
            window.location.href = data.redirect;
            return;
          }
        } catch (e) { /* ignore JSON parse errors */ }

        // Fallback: reload page — server likely set session/cookie
        window.location.reload();
      } else {
        // Non-2xx: show error and re-enable the button
        let text;
        try {
          text = (await res.json()).message || (await res.text());
        } catch (e) {
          text = 'Login failed. Please check your credentials.';
        }
        hideSpinner();
        // Minimal inline error feedback — you can replace with a nicer UI insertion
        alert(text || 'Login failed. Please try again.');
      }
    })
    .catch((err) => {
      // Network error — re-enable the button & stop spinner
      hideSpinner();
      console.error('Login request failed:', err);
      alert('Network error. Please try again.');
    });
});

/* Optional helper: if you have other code that needs to programmatically re-enable the button,
   call hideSpinner() when appropriate (e.g. after an AJAX failure handler) */



    })();
  </script>
</body>
</html>
